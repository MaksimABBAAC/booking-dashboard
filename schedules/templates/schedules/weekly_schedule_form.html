{% extends 'main/base.html' %}
{% load static %}

{% block style %}
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock style %}

{% block content %}
<h2>Создание нового расписания</h2>
<form method="post" id="schedule-form">
    {% csrf_token %}
    
    <!-- Основная информация -->
    <fieldset style="border: 1px solid #ddd; padding: 10px; margin-bottom: 20px;">
        <legend>Основные данные</legend>
        {{ form.as_p }}
    </fieldset>
    
    <!-- Дни недели -->
    <fieldset style="border: 1px solid #ddd; padding: 10px;">
        <legend>Расписание по дням</legend>
        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            {% for day_name, day_form in daily_forms %}
                <div class="day-card" style="border: 1px solid #eee; padding: 10px; border-radius: 5px; background: {% if day_form.is_working.value %}white{% else %}#f5f5f5{% endif %};">
                    <h3>{{ day_name }}</h3>
                    {% for field in day_form %}
                        {% if field.name == 'is_working' %}
                            <div class="form-group" style="margin-bottom: 10px;">
                                {{ field.label_tag }}
                                {{ field }}
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    <div class="day-fields" style="display: {% if day_form.is_working.value %}block{% else %}none{% endif %};">
                        {% if day_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ day_form.non_field_errors }}
                        </div>
                        {% endif %}
                        
                        {% for field in day_form %}
                            {% if field.name != 'is_working' %}
                            <div class="form-group" style="margin-bottom: 10px;">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    <div class="text-danger" style="color: red; font-size: 0.8em;">
                                    {% for error in field.errors %}
                                        {{ error }}<br>
                                    {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </fieldset>
    
    <button type="submit" class="btn btn-primary">Сохранить</button>
    <a href="{% url 'schedules:schedules' %}" class="btn btn-primary">Отмена</a>
</form>

<script>
    function toggleDayFields(checkbox) {
        const dayCard = checkbox.closest('.day-card');
        const dayFields = dayCard.querySelector('.day-fields');
        
        if (checkbox.checked) {
            dayFields.style.display = 'block';
            dayCard.style.background = 'white';
            
            dayFields.querySelectorAll('input, select').forEach(field => {
                field.required = true;
            });
        } else {
            dayFields.style.display = 'none';
            dayCard.style.background = '#f5f5f5';
            
            dayFields.querySelectorAll('input, select').forEach(field => {
                field.required = false;
                field.value = '';
            });
        }
    }

    document.querySelectorAll('input[type="time"]').forEach(input => {
        input.addEventListener('change', function() {
            const formGroup = this.closest('.form-group');
            const errorDiv = formGroup.querySelector('.text-danger');
            if (errorDiv) errorDiv.remove();
            
            const dayFields = this.closest('.day-fields');
            if (!dayFields) return;
            
            const start = dayFields.querySelector('[name$="-start_time"]')?.value;
            const end = dayFields.querySelector('[name$="-end_time"]')?.value;
            const breakStart = dayFields.querySelector('[name$="-break_start"]')?.value;
            const breakEnd = dayFields.querySelector('[name$="-break_end"]')?.value;
            
            // Проверка рабочего времени
            if (start && end && start >= end) {
                showError(dayFields.querySelector('[name$="-end_time"]'), 
                         'Время окончания должно быть позже времени начала');
            }
            
            // Проверка перерыва
            if (breakStart && breakEnd) {
                if (breakStart >= breakEnd) {
                    showError(dayFields.querySelector('[name$="-break_end"]'), 
                             'Окончание перерыва должно быть позже его начала');
                }
                
                if (start && breakStart < start) {
                    showError(dayFields.querySelector('[name$="-break_start"]'), 
                             'Перерыв не может начинаться до начала рабочего дня');
                }
                
                if (end && breakEnd > end) {
                    showError(dayFields.querySelector('[name$="-break_end"]'), 
                             'Перерыв не может заканчиваться после окончания рабочего дня');
                }
            }
        });
    });
    
    function showError(field, message) {
        if (!field) return;
        
        const formGroup = field.closest('.form-group');
        let errorDiv = formGroup.querySelector('.text-danger');
        
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger';
            errorDiv.style.color = 'red';
            errorDiv.style.fontSize = '0.8em';
            formGroup.appendChild(errorDiv);
        }
        
        errorDiv.textContent = message;
    }
    
    document.querySelectorAll('.day-card input[name$="-is_working"]').forEach(checkbox => {
        toggleDayFields(checkbox);
    });
</script>
{% endblock %}